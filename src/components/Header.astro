---
import { allServices } from '../data/services';
import { Image } from 'astro:assets';
import logo from '../assets/logo.jpg';

const navItems = [
  { href: '/', label: 'Home' },
  { 
    href: '/services', 
    label: 'Services',
    subItems: [
      { href: '/services', label: 'All Services' },
      ...allServices.map(s => ({ href: s.href, label: s.title }))
    ]
  },
  {
    href: '/patients',
    label: 'Patients',
    subItems: [
      { href: '/patients', label: 'Patient Center' },
      { href: '/patients/policies', label: 'Office Policies' },
      { href: '/patients/instructions', label: 'Procedure Instructions' },
    ]
  },
  { href: '/testimonials', label: 'Testimonials' },
  {
    href: '/about',
    label: 'About',
    subItems: [
      { href: '/about', label: 'About Our Practice' },
      { href: '/about/dr-pandya', label: 'Dr. Pandya' },
      { href: '/about/dr-patel', label: 'Meet Dr. Patel' },
    ]
  },
  { href: '/offices', label: 'Our Offices' },
];

const currentPath = Astro.url.pathname;
---

<header class="header-adaptive w-full top-0 z-50 transition-all duration-300 bg-white shadow-sm h-20 flex items-center" id="main-header">
  <nav class="container mx-auto px-6 flex justify-between items-center h-full">
    
    <!-- Logo -->
    <a href="/" class="flex items-center group relative z-50 h-full" aria-label="Danville Gastroenterology Center Home">
        <Image 
          src={logo} 
          alt="Danville Gastroenterology Center Logo" 
          class="h-12 md:h-14 w-auto mix-blend-multiply object-contain" 
          loading="eager"
          fetchpriority="high"
        />
    </a>

    <!-- Desktop Menu -->
    <div class="hidden lg:flex items-center gap-8 h-full">
      <ul class="flex gap-6 items-center h-full">
        {navItems.map((item) => {
          const isActive = currentPath === item.href || (item.href !== '/' && currentPath.startsWith(item.href));
          return (
            <li class="relative group h-full flex items-center">
              {item.subItems ? (
                <div class="flex items-center h-full">
                  <a href={item.href} class:list={[
                    "flex items-center gap-1 text-sm font-bold transition-colors uppercase tracking-wide bg-transparent border-none cursor-pointer p-0",
                    isActive ? "text-accent-dark" : "text-gray-700 hover:text-primary"
                  ]} aria-expanded="false" aria-haspopup="true">
                    <span class="relative py-1">
                      {item.label}
                      {isActive && <div class="absolute bottom-0 left-0 w-full h-0.5 bg-accent-dark rounded-full" aria-hidden="true"></div>}
                    </span>
                    <svg class="w-3 h-3 opacity-80 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <title>Dropdown arrow</title>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </a>
                  
                  <!-- Dropdown -->
                  <div class="absolute left-1/2 -translate-x-1/2 top-full opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform translate-y-2 group-hover:translate-y-0 z-[60]">
                      <ul class="w-64 bg-white shadow-2xl rounded-xl border border-gray-100 p-2 mt-2 ring-1 ring-black/5" role="menu" aria-label={`${item.label} submenu`}>
                          {item.subItems.map((sub) => {
                            const isSubActive = currentPath === sub.href || currentPath === sub.href + '/';
                            return (
                              <li role="none">
                                  <a href={sub.href} role="menuitem" aria-label={sub.label} class:list={[
                                    "block px-4 py-2.5 rounded-lg text-sm transition-colors",
                                    isSubActive ? "bg-secondary text-accent-dark font-bold" : "text-gray-700 font-semibold hover:bg-secondary/50 hover:text-primary"
                                  ]}>
                                  {sub.label}
                                  </a>
                              </li>
                            );
                          })}
                      </ul>
                  </div>
                </div>
              ) : (
                <a href={item.href} class:list={[
                  "relative text-sm font-bold transition-colors uppercase tracking-wide py-1",
                  isActive ? "text-accent-dark" : "text-gray-700 hover:text-primary"
                ]}>
                  {item.label}
                  {isActive && <div class="absolute bottom-0 left-0 w-full h-0.5 bg-accent-dark rounded-full" aria-hidden="true"></div>}
                </a>
              )}
            </li>
          );
        })}
      </ul>

      <!-- Divider -->
      <div class="h-8 w-px bg-gray-200" aria-hidden="true"></div>

      <!-- Actions -->
      <div class="flex items-center gap-4">
        <a href="tel:4347911152" class="hidden xl:flex flex-col items-end leading-tight text-gray-800 hover:text-primary transition-colors" aria-label="Call us at (434) 791-1152">
            <span class="text-[10px] font-semibold uppercase tracking-wider text-description">Call Us</span>
            <span class="font-semibold font-display">(434) 791-1152</span>
        </a>
        <button class="btn-primary py-2.5 px-6 text-sm shadow-md shadow-accent/20 trigger-booking" aria-label="Open appointment booking modal">
          Book Now
        </button>
      </div>
    </div>

    <!-- Mobile Menu Button -->
    <button id="mobile-menu-btn" class="lg:hidden text-gray-900 focus:outline-none relative z-50 p-2" aria-label="Toggle Navigation Menu" aria-expanded="false" aria-controls="mobile-menu">
      <div class="w-6 h-5 relative flex flex-col justify-between" aria-hidden="true">
          <span class="w-full h-0.5 bg-current rounded-full transition-all duration-300 origin-left" id="bar1"></span>
          <span class="w-full h-0.5 bg-current rounded-full transition-all duration-300" id="bar2"></span>
          <span class="w-full h-0.5 bg-current rounded-full transition-all duration-300 origin-left" id="bar3"></span>
      </div>
    </button>
  </nav>

  <!-- Mobile Menu Overlay -->
  <div id="mobile-menu" class="fixed inset-0 bg-white/95 backdrop-blur-xl z-40 translate-x-full transition-transform duration-300 lg:hidden flex flex-col pt-24 pb-8 px-6 overflow-y-auto" role="dialog" aria-modal="true" aria-label="Mobile Navigation">
    <ul class="flex flex-col gap-6">
      {navItems.map((item) => {
        const isActive = currentPath === item.href || (item.href !== '/' && currentPath.startsWith(item.href));
        return (
          <li class="border-b border-gray-100 pb-4 last:border-0 last:pb-0">
            {item.subItems ? (
              <details class="group">
                <summary class:list={[
                  "flex justify-between items-center text-xl font-bold cursor-pointer list-none font-display",
                  isActive ? "text-accent-dark" : "text-gray-900"
                ]}>
                  {item.label}
                  <span class="bg-gray-100 rounded-full p-1 group-open:rotate-180 transition-transform" aria-hidden="true">
                      <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <title>Expand menu</title>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                  </span>
                </summary>
                <ul class="pl-0 mt-4 flex flex-col gap-3">
                  {item.subItems.map((sub) => {
                    const isSubActive = currentPath === sub.href || currentPath === sub.href + '/';
                    return (
                      <li>
                        <a href={sub.href} aria-label={sub.label} class:list={[
                          "block py-2 text-base pl-4 border-l-2 transition-colors",
                          isSubActive ? "text-accent-dark border-accent-dark font-bold" : "text-description border-gray-100 hover:text-primary hover:border-accent-dark"
                        ]}>
                          {sub.label}
                        </a>
                      </li>
                    );
                  })}
                </ul>
              </details>
            ) : (
              <a href={item.href} class:list={[
                "block text-xl font-bold font-display",
                isActive ? "text-accent-dark" : "text-gray-900"
              ]}>
                {item.label}
              </a>
            )}
          </li>
        );
      })}
    </ul>
    
    <div class="mt-auto pt-8 border-t border-gray-100">
        <a href="tel:4347911152" class="flex items-center gap-3 text-lg font-semibold text-gray-800 mb-6 justify-center" aria-label="Call us at (434) 791-1152">
            <span class="bg-secondary p-2 rounded-full text-primary" aria-hidden="true">ðŸ“ž</span> (434) 791-1152
        </a>
        <button class="block w-full text-center btn-primary text-lg py-4 trigger-booking" aria-label="Open appointment booking modal">
          Book Appointment
        </button>
    </div>
  </div>
</header>

<style>
  /* Sticky only when there is enough vertical height (A11y Reflow compliance) */
  @media (min-height: 600px) {
    .header-adaptive {
      position: fixed;
    }
  }
  @media (max-height: 599px) {
    .header-adaptive {
      position: relative;
    }
  }
</style>

<script>
  const btn = document.getElementById('mobile-menu-btn');
  const menu = document.getElementById('mobile-menu');
  const bar1 = document.getElementById('bar1');
  const bar2 = document.getElementById('bar2');
  const bar3 = document.getElementById('bar3');
  const body = document.body;
  const bookingTriggers = document.querySelectorAll('.trigger-booking');

  // Open Booking Modal Logic
  bookingTriggers.forEach(trigger => {
      trigger.addEventListener('click', (e) => {
          e.preventDefault();
          // Close mobile menu if open
          if (menu && !menu.classList.contains('translate-x-full')) {
             btn?.click(); // Simulates closing
          }
          document.dispatchEvent(new CustomEvent('open-booking-modal'));
      });
  });

  if (btn && menu) {
    btn.addEventListener('click', () => {
      const isExpanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', (!isExpanded).toString());
      
      // Toggle Menu
      menu.classList.toggle('translate-x-full');
      
      // Animate Hamburger
      if (!isExpanded) {
          bar1?.classList.add('rotate-45', 'translate-x-px');
          bar2?.classList.add('opacity-0');
          bar3?.classList.add('-rotate-45', 'translate-x-px');
          body.style.overflow = 'hidden'; // Lock scroll
      } else {
          bar1?.classList.remove('rotate-45', 'translate-x-px');
          bar2?.classList.remove('opacity-0');
          bar3?.classList.remove('-rotate-45', 'translate-x-px');
          body.style.overflow = ''; // Unlock scroll
      }
    });
  }
</script>
